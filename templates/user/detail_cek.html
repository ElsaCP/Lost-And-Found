<!DOCTYPE html>
<html lang="id" itemscope itemtype="https://schema.org/WebPage">
<head>
  <meta charset="UTF-8">
  <title>Detail Laporan | Sistem Lost & Found</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">

  <link rel="stylesheet" href="{{ url_for('static', filename='css/detail_cek.css') }}">
</head>

<body>
<div class="modal fade" id="modalTutupLaporan" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content rounded-4 shadow">

      <div class="modal-header border-0">
        <h5 class="modal-title fw-bold text-primary">
          Konfirmasi Penutupan
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body text-center">
        <i class="bi bi-question-circle-fill text-primary fs-1 mb-3"></i>
        <p class="fs-5">
          Apakah Anda yakin tidak ada barang yang sesuai dengan laporan ini?
        </p>
      </div>

      <div class="modal-footer border-0 justify-content-center">
        <button type="button"
                class="btn btn-outline-secondary px-4"
                data-bs-dismiss="modal">
          Batal
        </button>

        <button type="button"
                class="btn btn-primary px-4"
                onclick="prosesTutupLaporan()">
          Ya, Tutup Laporan
        </button>
      </div>

    </div>
  </div>
</div>

<div itemscope itemtype="https://schema.org/Report">

  <meta itemprop="identifier" content="{{ laporan.kode_kehilangan }}">
  <meta itemprop="dateCreated" content="{{ laporan.tanggal_submit_fmt }}">
  <meta itemprop="dateModified" content="{{ laporan.update_terakhir_fmt }}">

<nav class="navbar navbar-expand-lg navbar-dark fixed-top">
  <div class="container-fluid">
    <a class="navbar-brand" href="#">
      <img src="{{ url_for('static', filename='image/logo injourney.png') }}" alt="Logo">
    </a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse justify-content-end" id="navbarNav">
      <ul class="navbar-nav align-items-center">
        <li class="nav-item"><a class="nav-link active" href="{{ url_for('main.home') }}#hero">Beranda</a></li>
        <li class="nav-item"><a class="nav-link" href="{{ url_for('main.home') }}#statistik">Statistik</a></li>
        <li class="nav-item"><a class="nav-link" href="{{ url_for('main.home') }}#panduan">Panduan</a></li>
        <li class="nav-item"><a class="nav-link" href="#kontak">Kontak</a></li>
        <li class="nav-item ms-lg-3">
          <a href="/login" class="profile-icon"><i class="bi bi-person-circle"></i></a>
        </li>
      </ul>
    </div>
  </div>
</nav>

<section class="header-detail container-fluid">
  <a href="javascript:history.back()" class="back-arrow-header">
    <i class="fa-solid fa-arrow-left"></i>
  </a>

  <img src="{{ url_for('static', filename='image/logo juanda 2.png') }}"
       alt="Logo Juanda 2"
       class="logo-juanda2">
</section>

<div class="container mt-3">
  <h3 class="fw-bold text-center" itemprop="name">
    Detail Laporan Kehilangan
  </h3>
</div>

<div class="container detail-card">

  <div class="row">

    <div class="col-md-4 text-center"
         itemprop="about"
         itemscope
         itemtype="https://schema.org/Product">

      <img src="{{ laporan.foto_url }}"
           class="foto-barang"
           alt="Foto Barang"
           itemprop="image">

      <meta itemprop="name" content="{{ laporan.nama_barang }}">
      <meta itemprop="category" content="{{ laporan.kategori }}">
    </div>

    <div class="col-md-8">

      <h4 class="fw-bold nama-barang" style="color:#0056a6;"
          itemprop="name">
        {{ laporan.nama_barang }}
      </h4>

      <p><b>Kode Laporan:</b>
        <span itemprop="identifier">{{ laporan.kode_kehilangan }}</span>
      </p>

      <p><b>Kategori:</b>
        <span itemprop="category">{{ laporan.kategori }}</span>
      </p>

      <p>
        <b>Status:</b>
        <span class="status {{ laporan.status }}" itemprop="reportStatus">
          {{ laporan.status }}
        </span>
      </p>

      <p>
        <b>Tanggal Submit:</b>
        <time itemprop="dateCreated">{{ laporan.tanggal_submit_fmt }}</time>
        ({{ laporan.waktu_submit_fmt }})
      </p>

      <p>
        <b>Update Terakhir:</b>
        <time itemprop="dateModified">{{ laporan.update_terakhir_fmt }}</time>
      </p>

    </div>
  </div>

  <hr>

  <div class="row mt-4">

    <div class="col-12 col-sm-6">
      <div class="info-card p-4"
           itemprop="author"
           itemscope
           itemtype="https://schema.org/Person">

        <h5 class="fw-bold mb-3" style="color:#0056a6;">Data Pelapor</h5>

        <div class="info-item"><span>Nama</span><p itemprop="name">{{ laporan.nama_pelapor }}</p></div>
        <div class="info-item"><span>Email</span><p itemprop="email">{{ laporan.email }}</p></div>
        <div class="info-item"><span>No. Telepon</span><p itemprop="telephone">{{ laporan.no_telp }}</p></div>

        <div class="info-item"
            itemprop="address"
            itemscope
            itemtype="https://schema.org/PostalAddress">

          <span class="info-label">Kota / Negara</span>

          <p class="info-answer">
            <span itemprop="addressLocality">{{ laporan.kota }}</span> /
            <span itemprop="addressCountry">{{ laporan.asal_negara }}</span>
          </p>
        </div>
      </div>
    </div>

    <div class="col-12 col-sm-6">
      <div class="info-card p-4">

        <h5 class="fw-bold mb-3" style="color:#0056a6;">Detail Kehilangan</h5>

        <div class="info-item"><span>Jenis Laporan</span><p>{{ laporan.jenis_laporan }}</p></div>

        <div class="info-item"
             itemprop="location"
             itemscope
             itemtype="https://schema.org/Place">
          <span>Lokasi Kehilangan</span>
          <p itemprop="name">{{ laporan.lokasi }}</p>
        </div>

        <div class="info-item">
          <span>Tanggal Kehilangan</span>
          <p>
            <time itemprop="eventDate">
            {{ laporan.tanggal_kehilangan.strftime("%d-%m-%Y") }}
            </time>
          </p>
        </div>

        <div class="info-item">
          <span>Deskripsi</span>
          <p itemprop="description">{{ laporan.deskripsi }}</p>
        </div>

      </div>
    </div>

  </div>
</div>

<div class="container mt-4 mb-4">
  <h4 class="fw-bold">Riwayat Perubahan Status</h4>

  {% if riwayat|length == 0 %}
    <div class="alert alert-info mt-3">Belum ada riwayat perubahan status.</div>
  {% else %}
    <div class="timeline">
      {% for r in riwayat %}
      <div class="timeline-item">
        <div class="timeline-dot"></div>
        <div class="timeline-content">
          <h6 class="fw-bold">{{ r.status }}</h6>
          <p class="text-muted">{{ r.waktu_update_fmt }}</p>
          <p>{{ r.catatan }}</p>
        </div>
      </div>
      {% endfor %}
    </div>
  {% endif %}
</div>

{% if status_laporan == 'Dalam Pencarian' %}
<div class="container mt-5">
  <h4 class="fw-bold mb-3">Rekomendasi Barang Serupa</h4>

  <div id="barangSerupaContainer" class="row g-4 rekom-grid"></div>

  <div class="mt-4 d-flex justify-content-between">
    <button class="btn btn-outline-secondary" id="btnBukanBarangSaya">Bukan Barang Saya</button>
    <button class="btn btn-primary" id="btnLihatLainnya" style="display:none">Lihat Lainnya</button>
  </div>
</div>
{% endif %}

  <section class="footer" id="kontak">
    <footer class="footer text-white" id="kontak">
      <div class="footer-container">
        <div class="footer-top">
          <div class="footer-logo">
            <img src={{ url_for('static', filename='image/logo putih.png')}} alt="InJourney Airports">
          </div>
          
          <div class="footer-address">
            <p>Jl. Juanda, Segoro Tambak, Kec. Sedati,<br>
            Kabupaten Sidoarjo, Jawa Timur 61253 - Indonesia</p>
          </div>

          <div class="footer-contact">
            <p><strong>Contact Center :</strong> @ccinjourneyairports</p>
            <p>ðŸ“ž 172 &nbsp; | &nbsp; ðŸ“§ cc172@injourneyairports.id</p>
            <p>Ph : T1 (+62 31 2986200) &nbsp; | &nbsp; T2 (+62 31 2986700)</p>
          </div>

          <div class="footer-icons">
            <a href="tel:(0623)12986200" class="text-white"><i class="fas fa-phone"></i></a>
            <a href="mailto:humas.sub@ap1.co.id" class="text-white"><i class="fas fa-envelope"></i></a>
            <a href="https://www.instagram.com/juanda_airport" target="_blank" class="text-white"><i class="fab fa-instagram"></i></a>
          </div>
        </div>

        <hr class="footer-divider">

        <div class="footer-bottom text-center small">
          Â© 2025 PT. ANGKASA PURA | BANDARA INTERNASIONAL JUANDA
        </div>
      </div>
    </footer>
  </section>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
let semuaRekomendasi = [];
let halaman = 1;
const perHalaman = 3;

document.addEventListener("DOMContentLoaded", () => {
    const kode = "{{ laporan.kode_kehilangan }}";

    fetch(`/api/rekomendasi/${kode}`)
      .then(res => res.json())
      .then(data => {
        semuaRekomendasi = data;
        renderHalaman();
        toggleBtn();
      });

    document.getElementById("btnBukanBarangSaya")
      ?.addEventListener("click", tutupLaporan);

    document.getElementById("btnLihatLainnya")
      ?.addEventListener("click", () => {
        halaman++;
        renderHalaman();
        toggleBtn();
      });
});

function renderHalaman() {
    const container = document.getElementById("barangSerupaContainer");
    container.innerHTML = "";

    const batas = halaman * perHalaman;
    const tampil = semuaRekomendasi.slice(0, batas);

    if (tampil.length === 0) {
        container.innerHTML = "<p class='text-muted'>Belum ada rekomendasi.</p>";
        return;
    }

    tampil.forEach(item => {
        container.innerHTML += `
        <div class="col-4 col-md-4 mb-3">
          <div class="rekom-card shadow-sm">
            <img src="${item.gambar_barang_url}" class="rekom-foto">
            <div class="rekom-body">
              <h6 class="fw-bold">${item.nama_barang}</h6>
              <p><b>Kategori:</b> ${item.kategori}</p>
              <p><b>Lokasi:</b> ${item.lokasi}</p>
              <p><b>Tanggal:</b> ${item.tanggal_lapor}</p>
              <a href="/detail-barang/${item.kode_barang}?lost={{ laporan.kode_kehilangan }}"
                 class="btn btn-primary btn-sm w-100">
                Lihat Detail
              </a>
            </div>
          </div>
        </div>`;
    });
}

function toggleBtn() {
    const btn = document.getElementById("btnLihatLainnya");
    if (!btn) return;

    if (semuaRekomendasi.length > halaman * perHalaman) {
        btn.style.display = "block";
    } else {
        btn.style.display = "none";
    }
}

function tutupLaporan() {
    const modal = new bootstrap.Modal(
        document.getElementById('modalTutupLaporan')
    );
    modal.show();
}

function prosesTutupLaporan() {
    fetch(`/api/tutup-laporan/{{ laporan.kode_kehilangan }}`, {
        method: "POST"
    })
    .then(res => res.json())
    .then(() => {
        const modalEl = document.getElementById('modalTutupLaporan');
        const modal = bootstrap.Modal.getInstance(modalEl);
        modal.hide();

        alert("Laporan berhasil ditutup.");
        location.reload();
    });
}
</script>
</body>
</html>
